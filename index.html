<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ï‡ßç‡¶∞‡¶ø‡¶ï‡ßá‡¶ü ‡¶ì ‡¶∏‡ßç‡¶ï‡ßã‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: #121212; color: white; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        
        /* Video Container */
        #video-container { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Scoreboard */
        .scoreboard { background: #1e1e1e; padding: 15px; border-radius: 8px; border: 2px solid #03dac6; margin-bottom: 20px; }
        .score-main { font-size: 2.5em; font-weight: bold; color: #03dac6; }
        .score-details { font-size: 1.2em; color: #aaa; margin-top: 5px; }

        /* UI Elements */
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; }
        .btn-primary { background: #6200ee; color: white; }
        .btn-danger { background: #cf6679; color: white; }
        .btn-admin { position: fixed; bottom: 10px; right: 10px; background: #333; color: #777; font-size: 0.8em; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #333; }

        /* Sections */
        .hidden { display: none; }
        #admin-panel { background: #222; padding: 20px; margin-top: 20px; border-radius: 10px; }
        .control-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .control-btn { padding: 15px; font-size: 1.2em; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        .control-btn:active { background: #555; }
        
        #status-msg { color: yellow; margin: 10px 0; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèè ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ï‡ßç‡¶∞‡¶ø‡¶ï‡ßá‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ</h1>

    <!-- Public View Section -->
    <div id="public-view">
        <div id="video-container">
            <video id="remote-video" autoplay playsinline controls></video>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);" id="loader">‡¶≤‡¶æ‡¶á‡¶≠ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        </div>

        <div class="scoreboard">
            <div class="score-main"><span id="runs">0</span>/<span id="wickets">0</span></div>
            <div class="score-details">‡¶ì‡¶≠‡¶æ‡¶∞: <span id="overs">0.0</span></div>
            <div class="score-details" id="match-status">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡ßü</div>
        </div>
        
        <div id="connection-box">
            <input type="text" id="join-id" placeholder="‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡ßã‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)">
            <button class="btn btn-primary" onclick="joinStream()">‡¶≤‡¶æ‡¶á‡¶≠ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            <p id="status-msg">‡¶≤‡¶æ‡¶á‡¶≠ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡ßü‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        </div>
    </div>

    <!-- Admin Button -->
    <button class="btn btn-admin" onclick="showAdminLogin()">Admin</button>

    <!-- Admin Section -->
    <div id="admin-login" class="hidden">
        <h2>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
        <div style="margin: 20px;">
            <button class="btn btn-primary" onclick="setupStreamer()">üé• ‡ßß. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ (‡¶≤‡¶æ‡¶á‡¶≠ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®)</button>
            <br><br>
            <button class="btn btn-primary" onclick="setupScorer()">üì± ‡ß®. ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶æ‡¶∞ (‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶¶‡¶ø‡¶®)</button>
        </div>
        <button class="btn btn-danger" onclick="location.reload()">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Streamer Panel (Phone 1) -->
    <div id="streamer-panel" class="hidden">
        <h3>‡¶Ü‡¶™‡¶®‡¶ø ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶¨‡ßç‡¶∞‡¶°‡¶ï‡¶æ‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá‡¶®</h3>
        <p>‡¶Ö‡¶®‡ßç‡¶Ø ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡¶æ‡¶≤‡ßç‡¶ü‡¶æ‡¶§‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®:</p>
        <div style="background:#333; padding:10px; font-size:1.5em; font-weight:bold; color:#03dac6;" id="my-id-display">...</div>
        <video id="local-video" autoplay playsinline muted style="width:100px; border:1px solid white;"></video>
        <p>‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶≠‡¶ø‡¶â‡ßü‡¶æ‡¶∞: <span id="viewer-count">0</span></p>
    </div>

    <!-- Scorer Panel (Phone 2) -->
    <div id="scorer-panel" class="hidden">
        <h3>‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶æ‡¶∞</h3>
        <input type="text" id="host-id-input" placeholder="‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®">
        <button class="btn btn-primary" onclick="connectToHostAsScorer()">‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        
        <div id="scoring-controls" class="hidden">
            <div class="control-grid">
                <button class="control-btn" onclick="updateScore('0')">0</button>
                <button class="control-btn" onclick="updateScore('1')">1</button>
                <button class="control-btn" onclick="updateScore('2')">2</button>
                <button class="control-btn" onclick="updateScore('3')">3</button>
                <button class="control-btn" onclick="updateScore('4')">4</button>
                <button class="control-btn" onclick="updateScore('6')">6</button>
                <button class="control-btn" style="background:#cf6679;" onclick="updateScore('W')">OUT</button>
                <button class="control-btn" onclick="updateScore('WD')">WD</button>
                <button class="control-btn" onclick="updateScore('NB')">NB</button>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="updateScore('OVER')">‡¶ì‡¶≠‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑</button>
        </div>
    </div>

</div>

<script>
    let peer;
    let conn; // Data connection
    let currentScore = { runs: 0, wickets: 0, overs: 0, balls: 0 };
    let viewers = [];

    // --- SETUP FUNCTIONS ---
    
    function showAdminLogin() {
        document.getElementById('public-view').classList.add('hidden');
        document.getElementById('admin-login').classList.remove('hidden');
        document.querySelector('.btn-admin').classList.add('hidden');
    }

    // Role 1: Streamer (Camera Mobile)
    function setupStreamer() {
        const customId = Math.floor(1000 + Math.random() * 9000); // Generate 4 digit code
        peer = new Peer(customId.toString());

        peer.on('open', (id) => {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('streamer-panel').classList.remove('hidden');
            document.getElementById('my-id-display').innerText = id;
            startVideo(true);
        });

        // Handle incoming connections (Viewers & Scorer)
        peer.on('connection', (c) => {
            if(c.metadata && c.metadata.type === 'scorer') {
                // It's the scorer phone
                c.on('data', (data) => {
                    handleScoreUpdate(data);
                    broadcastScore(data); // Send to all viewers
                });
                alert("‡¶∏‡ßç‡¶ï‡ßã‡¶∞‡¶æ‡¶∞ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            } else {
                // It's a viewer
                viewers.push(c);
                c.send(currentScore); // Send current score immediately
                document.getElementById('viewer-count').innerText = viewers.length;
            }
        });

        // Handle video calls
        peer.on('call', (call) => {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true })
                .then((stream) => {
                    call.answer(stream);
                });
        });
    }

    // Role 2: Scorer (Remote Controller Mobile)
    function setupScorer() {
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('scorer-panel').classList.remove('hidden');
    }

    function connectToHostAsScorer() {
        const hostId = document.getElementById('host-id-input').value;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(hostId, { metadata: { type: 'scorer' } });
            conn.on('open', () => {
                document.getElementById('scoring-controls').classList.remove('hidden');
                document.getElementById('host-id-input').classList.add('hidden');
                alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            });
        });
    }

    // Role 3: Viewer (Public)
    function joinStream() {
        const hostId = document.getElementById('join-id').value;
        if(!hostId) return alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®");

        document.getElementById('connection-box').classList.add('hidden');
        document.getElementById('loader').innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

        peer = new Peer();
        peer.on('open', () => {
            // 1. Connect for Data (Score)
            const conn = peer.connect(hostId);
            conn.on('data', (data) => {
                handleScoreUpdate(data);
            });

            // 2. Connect for Video
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }) // Dummy request to trigger permission
            .then((dummyStream) => {
                dummyStream.getTracks().forEach(track => track.stop()); // Stop dummy
                
                const call = peer.call(hostId, dummyStream);
                call.on('stream', (remoteStream) => {
                    const videoElem = document.getElementById('remote-video');
                    videoElem.srcObject = remoteStream;
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('match-status').innerText = "‚Ä¢ ‡¶≤‡¶æ‡¶á‡¶≠";
                    document.getElementById('match-status').style.color = "red";
                });
            }).catch(err => {
                console.log("Audio/Video permission needed even for viewing to handle auto-play policies.");
                // Fallback attempt without dummy stream
                const call = peer.call(hostId, null);
                call.on('stream', (remoteStream) => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                });
            });
        });
    }

    // --- LOGIC FUNCTIONS ---

    function startVideo(isStreamer) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true })
            .then((stream) => {
                if (isStreamer) {
                    document.getElementById('local-video').srcObject = stream;
                }
            })
            .catch(err => alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ: " + err));
    }

    function updateScore(action) {
        // Logic to calculate score
        if (action === 'W') {
            currentScore.wickets += 1;
            currentScore.balls += 1;
        } else if (action === 'WD' || action === 'NB') {
            currentScore.runs += 1;
            // Ball doesn't count
        } else if (action === 'OVER') {
            // Just UI update, calculation happens via balls
        } else {
            currentScore.runs += parseInt(action);
            currentScore.balls += 1;
        }

        // Calculate Overs
        let overs = Math.floor(currentScore.balls / 6);
        let balls = currentScore.balls % 6;
        currentScore.overs = overs + "." + balls;

        // Send to Host
        if (conn && conn.open) {
            conn.send(currentScore);
        }
    }

    function handleScoreUpdate(data) {
        currentScore = data;
        document.getElementById('runs').innerText = data.runs;
        document.getElementById('wickets').innerText = data.wickets;
        document.getElementById('overs').innerText = data.overs;
    }

    function broadcastScore(data) {
        viewers.forEach(c => {
            if(c.open) c.send(data);
        });
    }

</script>
</body>
</html>